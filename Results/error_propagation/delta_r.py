import numpy as np
import matplotlib.pyplot as plt

def ds_dk1(k4, k5, k6, r0, q):
    return r0**2*q/(1+k4*r0**2+k5*r0**4+k6*r0**6)


def ds_dk2(k4, k5, k6, r0, q):
    return r0**4*q/(1+k4*r0**2+k5*r0**4+k6*r0**6)


def ds_dk3(k4, k5, k6, r0, q):
    return -r0**6*q/(1+k4*r0**2+k5*r0**4+k6*r0**6)


def ds_dk4(k1, k2, k3, k4, k5, k6, r0, q):
    return -r0**2*q*(1+k1*r0**2+k2*r0**4+k3*r0**6)/(1+k4*r0**2+k5*r0**4+k6*r0**6)**2


def ds_dk5(k1, k2, k3, k4, k5, k6, r0, q):
    return -r0**4*q*(1+k1*r0**2+k2*r0**4+k3*r0**6)/(1+k4*r0**2+k5*r0**4+k6*r0**6)**2


def ds_dk6(k1, k2, k3, k4, k5, k6, r0, q):
    return -r0**6*q*(1+k1*r0**2+k2*r0**4+k3*r0**6)/(1+k4*r0**2+k5*r0**4+k6*r0**6)**2


def dr_dx(x, y, fx, fy):
    return fx**2*x/(np.sqrt((fx*x)**2+(fy*y)**2))


def dr_dy(x, y, fx, fy):
    return fy**2*y/(np.sqrt((fx*x)**2+(fy*y)**2))


def delta_x(k1, k2, k3, k4, k5, k6, p1, p2, s1, s2, dk1, dk2, dk3, dk4, dk5, dk6, dp1, dp2, ds1, ds2, r0, x, y):
    su = (ds_dk1(k4, k5, k6, r0, x)*dk1)**2\
         + (ds_dk2(k4, k5, k6, r0, x)*dk2)**2\
         + (ds_dk3(k4, k5, k6, r0, x)*dk3)**2\
         + (ds_dk4(k1, k2, k3, k4, k5, k6, r0, x)*dk4)**2\
         + (ds_dk5(k1, k2, k3, k4, k5, k6, r0, x)*dk5)**2\
         + (ds_dk6(k1, k2, k3, k4, k5, k6, r0, x)*dk6)**2\
         + (2*x*y*dp1)**2\
         + ((r0**2 + 2*x**2)*dp2)**2\
         + (r0**2*ds1)**2\
         + (r0**4*ds2)
         
    return np.sqrt(su)


def delta_y(k1, k2, k3, k4, k5, k6, p1, p2, s3, s4, dk1, dk2, dk3, dk4, dk5, dk6, dp1, dp2, ds3, ds4, r0, x, y):
    su = (ds_dk1(k4, k5, k6, r0, y)*dk1)**2\
         + (ds_dk2(k4, k5, k6, r0, y)*dk2)**2\
         + (ds_dk3(k4, k5, k6, r0, y)*dk3)**2\
         + (ds_dk4(k1, k2, k3, k4, k5, k6, r0, y)*dk4)**2\
         + (ds_dk5(k1, k2, k3, k4, k5, k6, r0, y)*dk5)**2\
         + (ds_dk6(k1, k2, k3, k4, k5, k6, r0, y)*dk6)**2\
         + ((r0**2 + 2*y**2)*dp1)**2\
         + (2*x*y*dp2)**2\
         + (r0**2*ds3)**2\
         + (r0**4*ds4)
         
    return np.sqrt(su)


def x_dist(k1, k2, k3, k4, k5, k6, p1, p2, s1, s2, r0, x, y):
    ret = x*(1+k1*r0**2+k2*r0**4+k3*r0**6)/(1+k4*r0**2+k5*r0**4+k6*r0**6)\
          + 2*p1*x*y + p2*(r0**2+2*x**2)\
          + s1*r0**2 + s2*r0**4
   
    return ret


def y_dist(k1, k2, k3, k4, k5, k6, p1, p2, s3, s4, r0, x, y):
    ret = y*(1+k1*r0**2+k2*r0**4+k3*r0**6)/(1+k4*r0**2+k5*r0**4+k6*r0**6)\
          + 2*p2*x*y + p1*(r0**2+2*y**2)\
          + s3*r0**2 + s4*r0**4
                 
    return ret


def delta_r(k1, k2, k3, k4, k5, k6, p1, p2, s1, s2, s3, s4, dk1, dk2, dk3, dk4, dk5, dk6, dp1, dp2, ds1, ds2, ds3, ds4, x, y, fx, fy):
    r0 = np.sqrt(x**2+y**2)
    x_d = x_dist(k1, k2, k3, k4, k5, k6, p1, p2, s1, s2, r0, x, y)
    y_d = y_dist(k1, k2, k3, k4, k5, k6, p1, p2, s3, s4, r0, x, y)
   
    su = (dr_dx(x_d, y_d, fx, fy)*delta_x(k1, k2, k3, k4, k5, k6, p1, p2, s1, s2, dk1, dk2, dk3, dk4, dk5, dk6, dp1, dp2, ds1, ds2, r0, x, y))**2\
         + (dr_dy(x_d, y_d, fx, fy)*delta_y(k1, k2, k3, k4, k5, k6, p1, p2, s3, s4, dk1, dk2, dk3, dk4, dk5, dk6, dp1, dp2, ds3, ds4, r0, x, y))**2
    
    return np.sqrt(su)

if __name__ == '__main__':
    # paramenters
    # fx = 2699.9737930742713
    # fy = 2700.378756414348

    # k1 = 5.360218856245703
    # dk1 = 1.7395892444535903
    # k2 = 37.59700575580601
    # dk2 = 1.9679204213678372
    # k3 = 49.47589225097392
    # dk3 = 18.26142101460492
    # k4 = 5.267656897338366
    # dk4 = 1.7479918783785375
    # k5 = 35.27141537150833
    # dk5 = 1.7012275903849983
    # k6 = 51.75254429743133
    # dk6 = 18.56826410602312

    # p1 = 0.0024965340337522283
    # dp1 = 0.00025288686109954656
    # p2 = 0.0018177199335993979
    # dp2 = 0.00025413120782346763

    # s1 = -0.001979367738678035
    # ds1 = 0.00036408980516592715
    # s2 = 0.00033097155430651155
    # ds2 = 0.00028910494696616064
    # s3 = -0.001988538594544449
    # ds3 = 0.000294172768146147
    # s4 = -0.001231022313690538
    # ds4 = 0.00027266459565735996
    
    
    # optimal 1
    fx = 2640.6473482132897
    fy = 2627.614868342684

    k1 = 0.06290928264550866
    dk1 = 0.0037187878150066185
    k2 = 43.59111181571908
    dk2 = 2.447400297360992
    k3 = -1.1829869845752556
    dk3 = 0.06872115512793193
    k4 = 0.0
    dk4 = 0.0
    k5 = 42.410748662305295
    dk5 = 2.3937282011938272
    k6 = 0.0
    dk6 = 0.0

    p1 = 0.002041904216583218
    dp1 = 0.0006383329973610179
    p2 = 0.002240121293539791
    dp2 = 0.0005378158659605494

    s1 = -0.0025138652348865483
    ds1 = 0.00039410435342240223
    s2 = -0.0008620515417826636
    ds2 = 0.0011088797031753213
    s3 = -0.001986019918033763
    ds3 = 0.0004888097477766277
    s4 = 0.0003108782022371937
    ds4 = 0.0008790747281794179
 
    # fx = 2700.0001510918332
    # fy = 2700.000238524841

    # k1 = 4.10056382007936
    # dk1 = 0.0006235292776692114
    # k2 = 36.00049122014371
    # dk2 = 0.0007463148891375013
    # k3 = 38.00503883217726
    # dk3 = 0.006570522438505947
    # k4 = 4.0005667752733745
    # dk4 = 0.000626550565412421
    # k5 = 34.0003540446532
    # dk5 = 0.0006482938143874157
    # k6 = 40.00516272413162
    # dk6 = 0.006680798900579744

    # p1 = 0.0020000837071363527
    # dp1 = 1.0611645732169746e-07
    # p2 = 0.0020000245913341006
    # dp2 = 1.092458935488051e-07

    # s1 = -0.0022000010022860776
    # ds1 = 1.5980012295945006e-07
    # s2 = 0.00012986418936238123
    # ds2 = 1.1775860223871079e-07
    # s3 = -0.0014001040473689682
    # ds3 = 1.268592143417099e-07
    # s4 = -0.0010000890027153306
    # ds4 = 1.1155883289171223e-07   
 
    res = 1
    x = np.arange(0, 2464/2, res)
    y = np.arange(0, 3280/2, res/2464*3280)
    
    dr = delta_r(k1, k2, k3, k4, k5, k6, p1, p2, s1, s2, s3, s4, dk1, dk2, dk3, dk4, dk5, dk6, dp1, dp2, ds1, ds2, ds3, ds4, x/fx, y/fy, fx, fy)
       
    plt.plot(np.sqrt(x**2+y**2), dr, label='dr')
    plt.legend()
    plt.grid(True)
    